name: ğŸ  Scraper ImÃ³veis Caixa - ExecuÃ§Ã£o DiÃ¡ria

on:
  # ExecuÃ§Ã£o automÃ¡tica todos os dias Ã s 8h da manhÃ£ (horÃ¡rio de BrasÃ­lia)
  schedule:
    - cron: '0 11 * * *'  # 11h UTC = 8h BRT (horÃ¡rio de verÃ£o: 9h BRT)
  
  # ExecuÃ§Ã£o manual via GitHub
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Modo teste (apenas uma cidade)'
        required: false
        default: 'false'
        type: boolean

jobs:
  scrape-imoveis:
    name: ğŸ” Buscar ImÃ³veis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install selenium webdriver-manager pandas beautifulsoup4 requests
          
      - name: ğŸ–¥ï¸ Instalar Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          google-chrome --version
          
      - name: ğŸ”§ Configurar variÃ¡veis de ambiente
        run: |
          echo "PYTHONPATH=$GITHUB_WORKSPACE/src" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
      - name: ğŸš€ Executar Scraper
        run: |
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            echo "ğŸ§ª Executando em modo teste..."
            python testes/teste_script_automatico.py
          else
            echo "ğŸš€ Executando scraper completo..."
            python scraper_automatico.py
          fi
        env:
          # ConfiguraÃ§Ãµes do email (serÃ£o definidas como secrets)
          EMAIL_REMETENTE: ${{ secrets.EMAIL_REMETENTE }}
          EMAIL_DESTINATARIOS: ${{ secrets.EMAIL_DESTINATARIOS }}
          SENHA_APP: ${{ secrets.SENHA_APP }}
          
      - name: ğŸ“¸ Capturar screenshot em caso de erro
        if: failure()
        run: |
          echo "âŒ Erro detectado! Capturando informaÃ§Ãµes de debug..."
          ls -la *.png *.txt *.json *.csv 2>/dev/null || echo "Nenhum arquivo de output encontrado"
          
      - name: ğŸ“¤ Upload de relatÃ³rios como artifacts
        uses: actions/upload-artifact@v3
        with:
          name: relatorios-${{ github.run_number }}
          path: |
            relatorio_*.txt
            imoveis_*.json
            imoveis_*.csv
            screenshot_*.png
          retention-days: 7
          
      - name: ğŸ“Š Resumo da execuÃ§Ã£o
        run: |
          echo "ğŸ“ˆ RESUMO DA EXECUÃ‡ÃƒO:"
          echo "======================"
          echo "Data/Hora: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Modo: ${{ github.event.inputs.test_mode == 'true' && 'Teste' || 'Completo' }}"
          
          # Contar arquivos gerados
          echo ""
          echo "ğŸ“ ARQUIVOS GERADOS:"
          echo "==================="
          echo "RelatÃ³rios: $(ls relatorio_*.txt 2>/dev/null | wc -l || echo 0)"
          echo "Dados JSON: $(ls imoveis_*.json 2>/dev/null | wc -l || echo 0)"
          echo "Dados CSV: $(ls imoveis_*.csv 2>/dev/null | wc -l || echo 0)"
          echo "Screenshots: $(ls screenshot_*.png 2>/dev/null | wc -l || echo 0)"
          
  notify-success:
    name: âœ… Notificar Sucesso
    runs-on: ubuntu-latest
    needs: scrape-imoveis
    if: success()
    
    steps:
      - name: ğŸ“§ Enviar notificaÃ§Ã£o de sucesso
        run: |
          echo "âœ… Scraper executado com sucesso!"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
  notify-failure:
    name: âŒ Notificar Falha
    runs-on: ubuntu-latest
    needs: scrape-imoveis
    if: failure()
    
    steps:
      - name: ğŸ“§ Enviar notificaÃ§Ã£o de falha
        run: |
          echo "âŒ Scraper falhou!"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ’¡ Verifique os logs para mais detalhes" 